const { PrismaClient } = require('@prisma/client');
const bcrypt = require('bcrypt');

const prisma = new PrismaClient();

async function main() {
  console.log('üå± Starting database seeding...');

  // Create admin user
  const hashedPassword = await bcrypt.hash('admin', 10);
  
  const admin = await prisma.user.upsert({
    where: { username: 'admin' },
    update: {},
    create: {
      username: 'admin',
      email: 'admin@olfong.is',
      password: hashedPassword,
      fullName: 'System Administrator',
      role: 'ADMIN',
      phone: '+3545551234',
    },
  });

  console.log('‚úÖ Created admin user:', admin.username);

  // Create sample delivery person
  const deliveryPassword = await bcrypt.hash('delivery123', 10);
  
  const delivery = await prisma.user.upsert({
    where: { username: 'delivery1' },
    update: {},
    create: {
      username: 'delivery1',
      email: 'delivery@olfong.is',
      password: deliveryPassword,
      fullName: 'J√≥n J√≥nsson',
      role: 'DELIVERY',
      phone: '+3545551235',
    },
  });

  console.log('‚úÖ Created delivery user:', delivery.username);

  // Create categories first - matching olfong.is structure
  const categories = [
    {
      name: 'WINE',
      nameIs: 'V√≠n',
      slug: 'vin',
      description: 'Wine products',
      descriptionIs: 'V√≠nv√∂rur',
      icon: 'üç∑',
      sortOrder: 1
    },
    {
      name: 'BEER',
      nameIs: 'Bj√≥r',
      slug: 'bjor',
      description: 'Beer products',
      descriptionIs: 'Bj√≥rv√∂rur',
      icon: 'üç∫',
      sortOrder: 2
    },
    {
      name: 'CIDER_RTD',
      nameIs: 'S√≠der & RTD',
      slug: 'sider-rtd',
      description: 'Cider and Ready-to-drink products',
      descriptionIs: 'S√≠der og tilb√∫in drykkir',
      icon: 'üçª',
      sortOrder: 3
    },
    {
      name: 'SPIRITS',
      nameIs: 'Sterkt √°fengi',
      slug: 'sterkt-afengi',
      description: 'Strong alcohol and spirits',
      descriptionIs: 'Sterkt √°fengi og brenniv√≠n',
      icon: 'ü•É',
      sortOrder: 4
    },
    {
      name: 'NICOTINE',
      nameIs: 'Nik√≥t√≠nv√∂rur',
      slug: 'nikotinvorur',
      description: 'Nicotine products',
      descriptionIs: 'Nik√≥t√≠nv√∂rur',
      icon: 'üö≠',
      sortOrder: 5
    },
    {
      name: 'NON_ALCOHOLIC',
      nameIs: '√ì√°fengir drykkir',
      slug: 'oafengt',
      description: 'Non-alcoholic drinks',
      descriptionIs: '√ì√°fengir drykkir',
      icon: 'ü•§',
      sortOrder: 6
    },
    {
      name: 'OFFERS',
      nameIs: 'Tilbo√∞in',
      slug: 'tilbodin',
      description: 'Special offers and deals',
      descriptionIs: 'S√©rst√∂k tilbo√∞ og afsl√¶ttir',
      icon: 'üè∑Ô∏è',
      sortOrder: 7
    }
  ];

  for (const category of categories) {
    await prisma.category.upsert({
      where: { name: category.name },
      update: {},
      create: category,
    });
  }

  console.log('‚úÖ Created categories');

  // Create subcategories for each main category
  const subcategories = [
    // Wine subcategories
    {
      name: 'WHITE_WINE',
      nameIs: 'Hv√≠tv√≠n',
      slug: 'hvitvin',
      description: 'White wine',
      descriptionIs: 'Hv√≠tv√≠n',
      icon: 'ü•Ç',
      sortOrder: 1,
      categoryName: 'WINE'
    },
    {
      name: 'RED_WINE',
      nameIs: 'Rau√∞v√≠n',
      slug: 'raudvin',
      description: 'Red wine',
      descriptionIs: 'Rau√∞v√≠n',
      icon: 'üç∑',
      sortOrder: 2,
      categoryName: 'WINE'
    },
    {
      name: 'SPARKLING_WINE',
      nameIs: 'Frey√∞iv√≠n',
      slug: 'freydivin',
      description: 'Sparkling wine',
      descriptionIs: 'Frey√∞iv√≠n',
      icon: 'üçæ',
      sortOrder: 3,
      categoryName: 'WINE'
    },
    {
      name: 'CHAMPAGNE',
      nameIs: 'Kampav√≠n',
      slug: 'kampavin',
      description: 'Champagne',
      descriptionIs: 'Kampav√≠n',
      icon: 'ü•Ç',
      sortOrder: 4,
      categoryName: 'WINE'
    },
    {
      name: 'YELLOW_WINE',
      nameIs: 'Gulv√≠n',
      slug: 'gulvin',
      description: 'Yellow wine',
      descriptionIs: 'Gulv√≠n',
      icon: 'üç∑',
      sortOrder: 5,
      categoryName: 'WINE'
    },
    {
      name: 'ROSE_WINE',
      nameIs: 'R√≥sav√≠n',
      slug: 'rosavin',
      description: 'Rose wine',
      descriptionIs: 'R√≥sav√≠n',
      icon: 'üç∑',
      sortOrder: 6,
      categoryName: 'WINE'
    },
    // Spirits subcategories
    {
      name: 'GIN',
      nameIs: 'Gin',
      slug: 'gin',
      description: 'Gin',
      descriptionIs: 'Gin',
      icon: 'ü•É',
      sortOrder: 1,
      categoryName: 'SPIRITS'
    },
    {
      name: 'COGNAC',
      nameIs: 'Koniak',
      slug: 'koniak',
      description: 'Cognac',
      descriptionIs: 'Koniak',
      icon: 'ü•É',
      sortOrder: 2,
      categoryName: 'SPIRITS'
    },
    {
      name: 'RUM',
      nameIs: 'Romm',
      slug: 'romm',
      description: 'Rum',
      descriptionIs: 'Romm',
      icon: 'ü•É',
      sortOrder: 3,
      categoryName: 'SPIRITS'
    },
    {
      name: 'LIQUEURS_SHOTS',
      nameIs: 'L√≠kj√∂rar & Skot',
      slug: 'likjorar-skot',
      description: 'Liqueurs & Shots',
      descriptionIs: 'L√≠kj√∂rar & Skot',
      icon: 'ü•É',
      sortOrder: 4,
      categoryName: 'SPIRITS'
    },
    {
      name: 'TEQUILA',
      nameIs: 'Tequila',
      slug: 'tequila',
      description: 'Tequila',
      descriptionIs: 'Tequila',
      icon: 'ü•É',
      sortOrder: 5,
      categoryName: 'SPIRITS'
    },
    {
      name: 'VODKA',
      nameIs: 'Vodka',
      slug: 'vodka',
      description: 'Vodka',
      descriptionIs: 'Vodka',
      icon: 'ü•É',
      sortOrder: 6,
      categoryName: 'SPIRITS'
    },
    {
      name: 'WHISKEY',
      nameIs: 'Viski',
      slug: 'viski',
      description: 'Whiskey',
      descriptionIs: 'Viski',
      icon: 'ü•É',
      sortOrder: 7,
      categoryName: 'SPIRITS'
    },
    // Nicotine subcategories
    {
      name: 'VAPE',
      nameIs: 'Veip',
      slug: 'veip',
      description: 'Vape products',
      descriptionIs: 'Veipv√∂rur',
      icon: 'üí®',
      sortOrder: 1,
      categoryName: 'NICOTINE'
    },
    {
      name: 'NICOTINE_PADS',
      nameIs: 'Nik√≥t√≠np√∫√∞ar',
      slug: 'nikotinpudar',
      description: 'Nicotine pads',
      descriptionIs: 'Nik√≥t√≠np√∫√∞ar',
      icon: 'üö≠',
      sortOrder: 2,
      categoryName: 'NICOTINE'
    },
    // Non-alcoholic subcategories
    {
      name: 'SODA',
      nameIs: 'Gos',
      slug: 'gos',
      description: 'Soda drinks',
      descriptionIs: 'Gosdrykkir',
      icon: 'ü•§',
      sortOrder: 1,
      categoryName: 'NON_ALCOHOLIC'
    },
    {
      name: 'SOFT_DRINKS',
      nameIs: 'S√≥davatn',
      slug: 'sodavatn',
      description: 'Soft drinks',
      descriptionIs: 'S√≥davatn',
      icon: 'ü•§',
      sortOrder: 2,
      categoryName: 'NON_ALCOHOLIC'
    },
    {
      name: 'ENERGY_DRINKS',
      nameIs: 'Orkudrykkir',
      slug: 'orkudrykkir',
      description: 'Energy drinks',
      descriptionIs: 'Orkudrykkir',
      icon: '‚ö°',
      sortOrder: 3,
      categoryName: 'NON_ALCOHOLIC'
    }
  ];

  // Create subcategories
  for (const subcategory of subcategories) {
    const category = await prisma.category.findUnique({ 
      where: { name: subcategory.categoryName } 
    });
    
    if (category) {
      await prisma.subcategory.upsert({
        where: { 
          categoryId_slug: {
            categoryId: category.id,
            slug: subcategory.slug
          }
        },
        update: {},
        create: {
          name: subcategory.name,
          nameIs: subcategory.nameIs,
          slug: subcategory.slug,
          description: subcategory.description,
          descriptionIs: subcategory.descriptionIs,
          icon: subcategory.icon,
          sortOrder: subcategory.sortOrder,
          categoryId: category.id
        }
      });
    }
  }

  console.log('‚úÖ Created subcategories');

  // Get category IDs for reference
  const wineCategory = await prisma.category.findUnique({ where: { name: 'WINE' } });
  const beerCategory = await prisma.category.findUnique({ where: { name: 'BEER' } });
  const nicotineCategory = await prisma.category.findUnique({ where: { name: 'NICOTINE' } });

  // Create sample products - Wine
  const wines = [
    {
      name: 'Bordeaux Red Wine',
      nameIs: 'Bordeaux rau√∞v√≠n',
      description: 'A classic French red wine with rich flavors',
      descriptionIs: 'Klass√≠skt franskt rau√∞v√≠n me√∞ r√≠kri brag√∞tegundum',
      categoryId: wineCategory.id,
      price: 4500,
      stock: 50,
      alcoholContent: 13.5,
      ageRestriction: 20,
    },
    {
      name: 'Chardonnay White Wine',
      nameIs: 'Chardonnay hv√≠tv√≠n',
      description: 'Crisp and refreshing white wine',
      descriptionIs: 'Hreint og hressandi hv√≠tv√≠n',
      categoryId: wineCategory.id,
      price: 3800,
      stock: 40,
      alcoholContent: 12.5,
      ageRestriction: 20,
      // ATVR fields for testing
      volume: '750 ml',
      country: 'France',
      producer: 'Domaine de la C√¥te',
      distributor: 'V√≠nb√∫√∞in',
      packaging: 'Glass bottle',
      foodPairings: ['Fiskur', 'Gr√¶nmetisr√©ttir', 'Alifuglar'],
      specialAttributes: ['Organic', 'Award winning', 'Limited edition'],
      atvrProductId: '12345',
      atvrUrl: 'https://www.vinbudin.is/desktopdefault.aspx/tabid-54/?productID=12345',
      availability: 'available',
    },
    {
      name: 'Prosecco Sparkling',
      nameIs: 'Prosecco frey√∞iv√≠n',
      description: 'Italian sparkling wine, perfect for celebrations',
      descriptionIs: '√çtalsk frey√∞iv√≠n, fullkomi√∞ fyrir h√°t√≠√∞ir',
      categoryId: wineCategory.id,
      price: 3200,
      stock: 30,
      alcoholContent: 11.0,
      ageRestriction: 20,
    },
  ];

  // Create sample products - Beer
  const beers = [
    {
      name: 'Craft IPA',
      nameIs: 'Handverks IPA',
      description: 'Hoppy and bitter craft beer',
      descriptionIs: 'Humla√∞ og beiskt handverksbj√≥r',
      categoryId: beerCategory.id,
      price: 450,
      stock: 200,
      alcoholContent: 6.5,
      ageRestriction: 20,
    },
    {
      name: 'Pilsner Lager',
      nameIs: 'Pilsner Lager',
      description: 'Light and refreshing lager',
      descriptionIs: 'L√©tt og hressandi lager',
      categoryId: beerCategory.id,
      price: 380,
      stock: 300,
      alcoholContent: 4.8,
      ageRestriction: 20,
    },
    {
      name: 'Stout Dark Beer',
      nameIs: 'Stout d√∂kkt bj√≥r',
      description: 'Rich and creamy dark beer',
      descriptionIs: 'R√≠kt og kremkennt d√∂kkt bj√≥r',
      categoryId: beerCategory.id,
      price: 520,
      stock: 150,
      alcoholContent: 7.2,
      ageRestriction: 20,
    },
  ];

  // Create sample products - Nicotine
  const nicotineProducts = [
    {
      name: 'Premium Nicotine Pouches - Mint',
      nameIs: 'Premium nik√≥t√≠npokar - Mynta',
      description: 'Strong mint flavored nicotine pouches',
      descriptionIs: 'Sterkar myntu√∞ nik√≥t√≠npokar',
      categoryId: nicotineCategory.id,
      price: 890,
      stock: 100,
      nicotineContent: 12.0,
      ageRestriction: 18,
    },
    {
      name: 'Light Nicotine Pouches - Berry',
      nameIs: 'L√©tt nik√≥t√≠npokar - Ber',
      description: 'Mild berry flavored nicotine pouches',
      descriptionIs: 'V√¶gur berjasmakandi nik√≥t√≠npokar',
      categoryId: nicotineCategory.id,
      price: 790,
      stock: 120,
      nicotineContent: 6.0,
      ageRestriction: 18,
    },
  ];

  // Insert all products
  for (const wine of wines) {
    await prisma.product.upsert({
      where: { id: wines.indexOf(wine) + 1 },
      update: {},
      create: wine,
    });
  }

  for (const beer of beers) {
    await prisma.product.upsert({
      where: { id: beers.indexOf(beer) + 4 },
      update: {},
      create: beer,
    });
  }

  for (const nicotine of nicotineProducts) {
    await prisma.product.upsert({
      where: { id: nicotineProducts.indexOf(nicotine) + 7 },
      update: {},
      create: nicotine,
    });
  }

  console.log('‚úÖ Created sample products');

  console.log('üéâ Database seeding completed successfully!');
}

main()
  .catch((e) => {
    console.error('‚ùå Error seeding database:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });


